---
title: "Module 1: Tabular Data"
subtitle: "Working with larger-than-RAM data using duckdbfs"
author: "Joey Zhang"
format: html
---

```{r}
library(duckdbfs)
library(dplyr)
```

```{r}
# Remote S3 path to EXIOBASE 3 (Source Cooperative)

duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)

# View the schema (column names and types) without reading data
glimpse(exio)
```

I want to indentify data on the co2 production country by country over time. 

opne the F_matrix table only in the daya, and let's look at the frist few rows.

```{r}
# Filter for F_satellite matrix only (environmental stressors)
f_matrix <- exio |>
    filter(matrix == "F_satellite")

# Look at the first few rows
f_sample <- f_matrix |>
    head(10) |>
    collect()

f_sample
```

```{r}
# Get all distinct stressor names to find CO2-related ones
stressors <- f_matrix |>
    distinct(stressor) |>
    collect()

# Filter for CO2 stressors
co2_stressors <- stressors |>
    filter(grepl("CO2", stressor, ignore.case = TRUE))

co2_stressors
```

```{r}
# CO2 production by country over time
co2_by_country_time <- f_matrix |>
    filter(grepl("CO2", stressor)) |>
    group_by(region, year) |>
    summarize(total_co2 = sum(value, na.rm = TRUE),
              unit = first(unit)) |>
    arrange(year, desc(total_co2)) |>
    collect()

co2_by_country_time
```

```{r}

```